Simulations and methods comparison. To validate the method and compare its performance to alternative approaches for detecting host-induced selection we carried out three simulation studies. First, we simulated data under the fitted model to evaluate power and accuracy. We used HIV-1 protease sequence data from three major public databases as a reference (Table 1; n ¼ 162; 901), and simulated 100 replicates of a data set of 460 study sequences with six different HLA-induced selection profiles, four of which were common (n ¼ 100 each) and two of which were rare (n ¼ 30 each); Supplementary Fig. 1 . We Fig. 1 The underlying process and our approximation. a The underlying process: infected hosts are circles, coloured by host factor information. Coloured strips represent the consensus pathogen sequence within infected hosts, and arrows indicate the direction of infection. Sampled hosts with pathogen sequence information are outlined. A red outline indicates that host factor information is also available. b Our approximation: pathogen sequences in D are generated from D B , modulated by host factors of D. As jD B j ) 0, we assume D B is the set of all possible sequences an individual can be infected with. Members of D arise from D B through recombination and mutation. We assume all selection along a lineage connecting each member of D to its closest neighbour in D B (subject to recombination) occurred within the host that the member of D was isolated from. Thus only host factor information for D is required. In b, there is one green host factor, h. Recombination, shown by the arrow, results in the colouring of the sequence. Three mutations have occurred: one due to h-associated selection (red star), one reversion (green circle), and one synonymous transition (black cross) performed simulations with recombination ranging between 0 and 0.01 (a rate of 0.01 meaning that on average the ancestor of each study sample copies 100 contiguous codons from a reference sample before recombination). We performed joint inference on the HLA-associated selection parameters across the viral sequence and examined how the size of the sample-specific reference panel (range: 10-100) affects estimates. Motivation behind the use of sample-specific reference panel and our approach is given in the Methods subsection: Restricting D B : sample-specific reference data sets. In the absence of recombination, parameter estimates are largely unbiased and accurate, although the rate of reversion has high variance ( Fig. 2 ; Supplementary Fig. 2 ). Estimates for rare alleles perform similarly to those for common alleles (Fig. 2b) . We find little impact of the size of the sample-specific reference data set and the posterior distributions are well calibrated ( Supplementary Fig. 3) . Recombination leads to a downward bias in estimates of recombination and selection intensity and upward bias in the rate of reversion ( Fig. 2c ; Supplementary  Fig. 4 ) and consequently poorer posterior calibration at sites under selection ( Supplementary Fig. 4) . Nevertheless, the inferred profiles of host-dependent and host-independent selection pressures remain strongly correlated to the truth. We also considered the impact of error in choosing the sample-specific reference panel by forcing inclusion of the sequences actually copied. We find that forcing the true ancestors to be included improves accuracy by only a small margin ( Supplementary Fig. 5 ) indicating that 100 potential ancestors chosen through Hamming distance is typically sufficient. In the second set of simulations we assessed robustness by simulating data under a birth-death model (without recombination), setting the current infected population size at 1,000,000 and sampling proportion at 10% to define D B and sample 1,460 query sequences with associated host HLA information (see Methods subsection: Simulation study 2: simulating a sampled birth-death process for details). We find some attenuation of the selection signal (and over-estimation of the reversion parameter) but strong correlation between the inferred and estimated strengths of host-dependent and host-independent selection ( Fig. 2c ; Supplementary Fig. 6 ). The birth-death simulations also enable comparison of our approach with five alternative methods for identifying sites under host factor specific selection (Supplementary Methods subsection: Simulation study 2: methods comparison): Fisher's exact test (as in Moore et al. 16 ); a phylogenetically corrected Fisher's exact test (as in Bhattacharya et al. 22 ); an approximate escape rate estimate (as in Fryer et al. 18 ); a 'Phylogenetic dependency networks' approach-PhyloD (as in Carlson et al. 25 ); and PhyloD OR (as in Carlson et al. 21 ). In each case, we assume that the wild-type consensus strain is correctly defined and set any nonsynonymous difference from consensus as a candidate for escape. For each method, we obtained p values or parameter estimates that provide a metric for the strength of selection conditional on each HLA type and generated receiver operating characteristic curves for each simulation (Fig. 2e) . We find that our approach dramatically increases sensitivity for a given false-positive rate (FPR). For example, at FPR = 0.01, our sensitivity is 0.61, compared to the second best-performing method, PhyloD, at 0.13. To assess whether the difference between methods decreases with sample size, we repeated the analysis with 3000 query sequences. Our method achieves a sensitivity of 0.81 (at an FPR of 0.01), compared to the next best-performing method, PhyloD, at 0.22 ( Supplementary Fig. 7) . We conclude that augmenting study data with a large reference data set and modelling the escape process explicitly provides a substantial gain in the ability to identify sites under host factor specific selection. To examine the impact of a reduced reference sequence data set, we randomly subsampled 10 and 1% of D B from Simulation study 2. We also considered a leave-one-out (LOO) strategy, where the reference data are augmented with study sequences, with the exception of the sample under consideration. We find that larger reference panels achieve greater accuracy. For example, at FPR = 0.01, sensitivity ranges from 0.61 with the full reference to 0.49 with 10% and 0.32 with 1%. The LOO strategy only boosts power if the reference panel is of the order of the sample size. However, in the absence of any reference panel, our method with a LOO strategy still achieves considerably greater power (sensitivity of 0.34 at FPR = 0.01) than any competing method ( Supplementary Fig. 8 ). In the third simulation study (Methods subsection: Simulation study 3: the effect of population differentiation), we used an empirical bootstrap approach to assess robustness to population structure and the impact of both differentiation between D and D B and relatedness within D, taking the parameters estimated from empirical data (see Results: HLA-associated selection). We used viral sequence data from Botswana (n ¼ 343, protease only) to simulate ancestors and the empirical distribution of HLA genotype frequencies from this sample. We measured the accuracy of estimates (both in terms of bias and calibration of posteriors) for different protease reference panels, ranging from the ideal panel (i.e., the ancestors used in the simulation), to that used in this study, to one that considered only the 57,969 sequences known not to come from Botswana. The latter panel maximises differentiation and also introduces the potential problem of sequences within D typically being more closely related to each other than to members of D B . Results are summarised in Supplementary Figs. 9-11. In terms of bias (summarised by the frequency-weighted root mean square error (RMSE) between true and inferred HLA-associated selection profiles) we find relatively little differences between panels, with the most diverged reference panel being only 3% worse than the best. The estimator was well calibrated for each reference panel used: 95% and 50% credible intervals contained the true value at between 91-98% and 45-57% of sites across bootstrap replicates, respectively. Typically, the LOO strategy had little effect on estimator performance. We conclude that the approach gives substantial robustness to population structure and within-sample relatedness, enabling the integration of highly diverse data sets, though note that very highly diverged reference data sets (for example, consisting of a separate subtype) will perform poorly. Drug-associated selection. To provide empirical validation of our approach for detecting host factor dependent selection we analysed HIV-1 data from the Stanford drug resistance database 9 in which viral sequences are linked to antiretroviral drug treatment history of the patient. We therefore aim to learn drugtreatment specific evolution, while other selective factors (e.g., selection due to cytotoxic-T-lymphocyte (CTL) pressure, the Inference results for Simulation studies 1 and 2 are shown in a-d. a Simulation study 1; r ¼ 0. γ for a common HLA (n = 100), dN dS ratio, recombination probability between adjacent sites (r), and reversion scaling (ζ). b Simulation study 1; r ¼ 0. γ for a rare HLA (n ¼ 30). c Simulation study 1; r ¼ 0:01, γ for a common HLA (n ¼ 100). d Simulation study 2, γ for a common HLA (n ¼ 100). In a-d, (except ω in a), averages are taken over 100 independent MCMC runs on independent simulated data with the same underlying parameters. The true value is shown in blue, mean and median estimates are in black and red, respectively. White bands enclose 50% credible intervals, in turn enclosed by grey 95% credible intervals. In c, the truth is rescaled by the average number of individuals between a randomly chosen pair of leaves in the sampled birth-death tree. For ω in a, averages are taken over a single-MCMC run, chosen at random as ω differs across simulation runs (sampled from the prior). See Supplementary Figs. 2-5 for full results summaries. e ROC curves for existing method. Six methods used to identify HLA-associated selection on viral sequence are applied to data simulated under the birth-death process used in simulation study 2. The Inset zooms in to the region enclosed by the black box. ROC curves for 100 independent birth-death simulations are lightly coloured, and averaged to generate the heavier lines. ROC curves for Fryer Approx, PhyloD and PhyloD OR do not extend to (1, 1) . For Fryer Approx this is because we stop our threshold for estimated rates at 0. For PhyloD and PhyloD OR, it is because many sites will not be included in leaf distribution or logistic regression respectively. Source data are provided as a Source Data file antibody response, or the APOBEC3G response) will be captured by ω. We analysed protease and reverse transcriptase independently and excluded integrase due to lack of data 9 . Priors on parameters are given in Supplementary Table 1 . We defined the collection of sequences in hosts not receiving any therapy at the time of sequencing as D B , and viral sequences in hosts receiving any treatment (coupled with their drug regime data) as D. To guarantee the presence of variation in drug selection we introduce a null class by randomly assigning 2,000 sequences from D B to D. Details of data preparation are given in the Supplementary Methods subsection: Query and reference data set preparation. We estimated γ h;i for protease and reverse transcriptase inhibitors prescribed to at least 10 individuals in D ( Fig. 3a ; Supplementary Fig. 12 ), and identified sites with very strong evidence for drug-induced escape (median estimate of selection factor >2 and at least 97.5% of the posterior >1; top-tier) and moderate evidence (median estimate of selection factor >1.5 and at least 90% of the posterior >1; second-tier). We compared the enrichment of sites identified to known (experimentally validated) major drug resistance mutations (DRMs) 9 (Fig. 3b) . For some drugs, DRM data was lacking because the drug is no longer commonly used (DDC and DLV), was an experimental drug that failed (αAPA, and ADV) or is now used in small amounts with other drugs (RTV). We observed strong, statistically significant and consistent enrichment of DRMs at sites identified as selected; with elevated enrichment (as measured by odds ratio) in the strongest DRMs and sites with strongest evidence for selection. For example, of the 31 strongest DRMs in reverse transcriptase, 11 are found in the top-tier selected sites and a further 6 in the second-tier. Of the 41 apparent false positive sites, 17 are described as being selected for in the literature (but not classified as a major DRM in the Stanford database); for example mutation at codon 11 of reverse transcriptase is known to be associated with minor reductions in APV susceptibility 29 , but is not classified as a major DRM 9 . A further three apparent false positive are DRMs for treatment cocktails including the drug, nine are sites of DRMs for drugs in the same class but where more specific information is not provided, seven are DRMs for different drugs in the same class and only five appear to have no support in the literature (Supplementary Table 2 ). False negatives are caused by sites where the selected codon is more than one nucleotide change away from the consensus (five mutations), one is an insertion, eight have in vitro support for drug resistance but are not documented as being selected for in vivo, seven have no compelling evidence in the literature and three are genuinely missed (Supplementary Table 3) 9 . Further evidence for the biological validity of the inferred profiles is given by the coclustering of related drugs in trees constructed from the selection intensity profiles ( Supplementary Fig. 13 ). In summary, we find that the method can identify sites selected by specific drug treatments in vivo, either directly through resistance or indirectly through compensation for resistance mutations that reduce fitness. HLA-associated selection. While the extent to which host HLA alleles can influence patterns of escape and reversion in HIV-1 has been studied extensively, the methods developed here provide additional power and accuracy as well as provide control against factors such as population stratification and recombination. Moreover, the methody also provides a framework in which to combine data from multiple previous studies. We have assembled nearly 3000 HIV-1 sequences from patients with known HLA class I genotypes from six studies, of European and African ancestry representing a mixture of subtype B and C sequences ( Table 2) . We augmented the data with HIV-1 genome data taken from three sources, representing 250,000-280,000 sequences depending on the gene (Table 1) . We analysed the data in two ways, first by considering escape as deviation from subtype B and also by considering escape from subtype C. We expect these analyses to yield similar results, except at sites where subtypes differ systematically. We analysed data from protease and reverse transcriptase and inferred the impact of alleles at HLA class I loci (at 2-digit resolution) jointly. We restricted analysis to HLA alleles with at least 10 representatives in the data. We truncated to 2-digit HLA resolution to boost power as the majority of alleles are rare (61% of 4-digit HLA alleles have <10 copies, compared to 30% at 2-digit resolution). Further, 27.3% of the individuals for whom we have HLA information were typed to the 2-digit level. Full details of data preparation are given in the Supplementary Methods subsection: Query and reference data set preparation. We define 'top-tier' HLA-associated candidate sites as those where the median γ h;i > 2 and the lower 2.5% quantile > 1, and 'second-tier' candidate sites as those where the 10% quantile of γ h;i > 1. To illustrate the value of our approach, we first considered the B*51 restricted epitope TAFTIPSI in reverse transcriptase ( Fig. 4) . We find a strong signal of selection within the epitope, with the escape site (position 135) experiencing the strongest rate elevation. Interestingly, a variant at site 129 which is known to abrogate CTL recognition in vitro 30 , is highly conserved in vivo and shows no signal for selection, presumably due to other fitness consequences. In contrast, we also see strong evidence for B*51 associated escape around codons 173 and 195, which have not been reported previously. Other known allele-epitope combinations that we recover include, for example, B*18 associated selection around codon 138 [31] [32] [33] . To compare to experimental and previous work on epitope restriction we classify documented epitopes into an A-list, which Fig. 4 Selected results summaries. a B*51 associated selection away from C ¼ C across the analysed region of reverse transcriptase. Site numbering is relative to the HXB2, starting from beginning of reverse transcriptase. Plotting is as in Fig. 2a-d. The B*51 epitope TAFTIPSI is highlighted by the blue boxthe site of the known escape variant is highlighted red. The black rectangle is zoomed in on in b. c Epitopes predicted by Motif Scan and A-list/B-list epitopes for two example HLA types are displayed. Corresponding results from our inference are shown on the grey strips-colouring is summarised by the key. Source data are provided as a Source Data file represents the best-defined experimentally determined HIV-1 CTL epitopes, updated yearly 34 and a B-list, which refers to the entire collection of epitopes reported in the literature 35 . Among the A-list epitopes, some have documented CTL escape variants, either in vivo or in vitro. See Supplementary Tables 4 and 5 for details and Supplementary Notes. We also consider an in silico set of predictions for strongly-binding anchor residues generated by Motif-Scan 36 . We compare these sites to our estimates of HLAassociated selection across protease and reverse transcriptase (Fig. 5, Supplementary Figs. 9-13 ). To assess overlap between sites identified we measured the enrichment of sites identified as under selection and used a permutation strategy to assess significance (Methods subsection: Testing overlap with A-list and B-list epitopes). Across protease and reverse transcriptase we find strong enrichment of top-tier signals of selection at A-list epitopes for HLA-B (Table 3) . For example, toptier sites have an odds ratio of 63 for enrichment in A-list epitopes (p ¼ 0:003). As the confidence in the epitope collection or the strength of selection decreases, so does the enrichment. We find no evidence for enrichment of selection at computationally predicted epitopes and little evidence for overlap of HLA-A associated sites, though in general we note that HLA-A alleles show much weaker evidence for selection in general ( Supplementary Figs. 14 and 17) . We also find very little evidence for HLA-C driven selection at all (Supplementary Figs. 16 and 18) . Comparing our results to those in Carlson et al. 37 , focusing on the well-studied HLA-B associations, we find that 100% of the sites that are both in our top-tier and q < 0:2 in Carlson et al. 37 reside in A-list or B-list epitopes (Supplementary Tables 6 and 7) . Subsets of method specific HLA associations also lie in A-list and B-list epitopes, which, given the overlap in subtype C viral samples (100% of subtype C viral sequence data with associated host HLA information was present in Carlson et al. 37 ) suggest that the approaches are complementary, each likely detecting distinct portions of the true underlying signal. For example, our notion of escape means that we cannot detect HLA-associated selection to the consensus codon. Overall, only a small number of sites identified here as being HLA-associated have been described and experimentally validated previously; four in reverse transcriptase (Table 4) , and one in protease (Table 5) . Conversely, not all previously reported escape mutation sites are identified here. In some cases this may be due to low-sample size in this study. However, it is also possible that earlier studies failed to account adequately for linkage disequilibrium between HLA alleles. We also identified potentially novel signals of HLA-driven epitope escape. For a Motif scan compared to our inference. Inference of HLA-associated selection from C ¼ C is summarised on the grey strips: sites with median γ h;i > 2 and 1.5 are coloured red and orange respectively, sites with 2.5% and 10% quantile > 1 are outlined in black and white, respectively. Blue and green vertical lines tag sites of drug resistance mutations and sites that differentiate subtype B/C viruses at the amino-acid level. We scan reverse transcriptase for putative epitopes matching to known binding motifs in the literature; see key. Anchor residues are highlighted in red. b A-list/B-list compared to our inference. Inference results on the grey strips are coloured as in a. Two grey strips per HLA show selection away from C ¼ B and C ¼ C respectively. Bar plots to the right show HLA frequencies. The two lowest strips summarise median ω according to the colour bar. A-list 34 and B-list 35 epitopes above the grey are coloured purple and pink respectively. Sites of known escape variants within the A-list epitopes are highlighted yellow. Source data are provided as a Source Data file. NATURE COMMUNICATIONS | https://doi.org/10.1038/s41467-019-10724-w ARTICLE example, B*45 shows multiple signals of selection around codon 200 of reverse transcriptase (Fig. 5 ), yet there are no reported epitopes. This may reflect a historical bias towards studies being carried out in European-ancestry populations with subtype B viruses where some HLA alleles and viral epitopes are rare. However, we also note that results between the subtype B and subtype C consensus analyses are highly concordant, with a few interesting exceptions. For example, B*58 shows evidence for inducing strong selection away from the subtype B consensus around codon 122-123 of reverse transcriptase but not away from the subtype C consensus. Interestingly, this is a position of divergence between subtype B and subtype C viruses and B*58 is typically more common in populations with HIV-1 subtype C viruses, suggesting that B*58-induced selection pressure may have driven the fixation of the difference between subtypes. More generally, we found that average selection intensity away from the subtype C consensus in individuals carrying subtype B virus is significantly stronger than the average selection intensity away from the subtype B consensus (Supplementary Fig. 20 : protease p ¼ 2:8 10 À5 , reverse transcriptase p ¼ 2:0 10 À6 ; see Methods subsection: The impact of HLA on HIV-1 sequence evolution for details), though only reverse transcriptase was significant in the inverse setting (p ¼ 0:0058, protease p ¼ 0:70). Moreover, we estimate that the combined contribution of HLA-associated diversifying selection to non-synonymous viral sequence change represents 59 and 77% of selection from subtype B and C consensus in protease, and 61 and 78% in reverse transcriptase (Methods subsection: Testing the impact of HLA on HIV-1 subtype differentiation, and Supplementary Table 8 ). In summary, we estimate that HLAdriven selection accounts for more than half of all HIV-1 coding changes and has contributed to diversification between subtypes. To assess the relationship between sequence similarity between HLA alleles and the inferred HLA-induced selection profiles, we measured the concordance between dendrograms inferred from pairwise differences of classical HLA alleles protein sequences and dendrograms inferred from the estimated selection profiles (Supplementary Methods; Dendrograms of selection profiles and comparing topologies). We find that closely related HLA alleles have closely related selection profiles for HLA-A (odds ratio = 2.1; permutation p value = 0.017) and HLA-B (odds-ratio = 3.1; permutation p value = 0.014), but not HLA-C (odds ratio = 0.71; permutation p value = 0.71). However, deeper structure within the inferred trees shows little concordance. These findings provide biological validation for our results and suggest that future work to incorporate relationships between HLA allele would be valuable. Finally, as noted recently 38 , a number of sites both show evidence of HLA-driven selection as well as being associated with evolution in response to drug treatment (for example, around codon 70 in reverse transcriptase for B*45). Depending on whether the two types of selection act in the same or different directions, such pressures could either speed up or delay the origin of drug resistance. These results suggest that HLA genotype could be a predictor of the response to drug treatment. Permutation p values for overlap are displayed for each collection of putative epitopes, with odds ratios displayed in parentheses. a Putative epitopes were generated using the subtype C consensus; results using the subtype B consensus were similar. Source data are provided as a Source Data file  