Data Collection and Assembly. The bat species analyzed in this study and the type of data associated with each are shown in Table 1 . For a few bat species, genomic (chromosomal) sequences are available, and for others, transcriptomic sequences exist. For each bat species with an annotated genome project, we downloaded the relevant RefSeq database from the National Center for Biotechnology Information (NCBI) website and extracted the protein and coding sequence of the longest isoform of each gene for orthology search. After finding orthologous genes from each species, we selected the gene isoform which most closely matched the consensus sequence for further analysis (Methods). Genome assembly accession numbers, as well as basic assembly statistics, for each genome are given in SI Appendix, Table S1 . Human, common shrew (Sorex araneus), and pig (Sus scrofa) genomes were also included as outgroups. Finally, we harvested mRNA and sequenced the transcriptomes of H. monstrosus and R. aegyptiacus on Illumina machines (Methods). For all other bats with available transcriptome data, we downloaded the raw sequencing reads from the Sequence Read Archive (SI Appendix, Table S2 ) (23, (27) (28) (29) (30) (31) (32) (33) (34) (35) (36) (37) (38) . For the sake of consistency, we constructed transcriptome assemblies using our own pipeline, even in the cases where authors made assemblies publicly available. Briefly, our pipeline consisted of removing adapter sequences with Trimmomatic (39), followed by using two of the most popular transcriptome assemblers, the De Bruijn graph-based Trinity (40) and Trans-ABySS (41) Each species analyzed in this study, along with basic information concerning data type (genomic or transcriptomic), the number of genes here placed in orthologous gene sets, the N50 statistic (50% of bases are in contigs of length at least N50), and guanine-cytosine content (%GC) of these genes. For bats with transcriptomic data, data were all assembled and annotated as part of this study, and the number of assemblies constructed and analyzed is listed. For the other species, genomic data and annotations were all downloaded from RefSeq. Transcriptome data for two species, shown with asterisks, were generated in this study. assemblers, with a range of input parameters. This resulted in multiple tentative assemblies per bat (Table 1 and Methods) (39) (40) (41) (42) . Building Orthologous Gene Families. The search for orthologous genes was performed in two primary steps. First, we searched for orthologs in the genomic datasets. With genomic data, one is able to use syntenic information to help predict orthology. We used all-v-all BLAST reciprocal best hits of the protein sequences, filtered using three sources of syntenic information: public orthology predictions from BioMart, proximity via whole genome alignment, and proximity of similar neighboring genes (43) (44) (45) . Second, we searched for orthologs in transcriptomic datasets. We selected the best BLAST reciprocal best hits in transcriptomic data against genes found in the genomic orthologous gene sets, filtered by search using HMMER (46) , a hidden Markov model-based homology search software package, and filtered by match length (Methods). In all, we were able to place 192,686 transcripts into 11,677 orthologous gene sets, of which 1,107 contain genes from all species and outgroups. Fig. 1 shows the number of transcriptomic genes found by species. Also shown is the number of genes we would have found in each species had we known a priori which assembly would perform the best for each bat and only assembled that one. With the additional work of analyzing multiple assemblies per bat, we were able to identify 9-22% more genes per bat relative to the best single assembly, representing thousands of added transcripts and improvements to the completeness of the gene network. Multiple Sequence Alignment Cleaning. Manual inspection of many multiple sequence alignments of orthologous genes revealed a nonrandom source of error: the species were biased toward segregating by data type (i.e., genomic data vs. transcriptomic data). Some poorly aligned regions would tend to agree within data type but disagree between data types. An example is shown in Fig. 2A . Furthermore, the splits were observed to happen at sharp boundaries highly suggestive of exon boundaries. This effect can be largely explained by the fact that we chose the longest isoforms predicted from annotated genome sequences, even though the longest isoforms might not be expressed at high enough levels to appear in the transcriptomic datasets from a given tissue. Other artifacts in transcriptomic or genomic data assembly and annotation could also contribute to this effect. Quantification of this bias, based on the cleaning pipeline described below, is shown in SI Appendix, Fig. S2 . To ameliorate nonrandom assembly and isoform-selection artifacts, we developed a three-step cleaning algorithm for the multiple sequence alignments (Fig. 2B) . First, we revisited each gene derived from genomic data and replaced it, if necessary, with the isoform closest to the consensus sequence. This resulted in improvements to 3,444 transcripts, with transcripts improving their match to the consensus sequence by an average of 8%, although there was a wide range of percent improvements (Fig. 2C) . Second, we removed exons if the species did not all agree on the exon structure. Specifically, we removed exons if all species did not agree on the aligned exon boundaries or if exon sequences differed too much in length. For phylogenetic analysis, where all genes are used in aggregate to fit a single tree, we required exact agreement in exon lengths. For gene-level positive selection analysis we required exons differ by no more than 1%. This cutoff was chosen because we observed it to be a transition point to high-gap exons in our data (SI Appendix, Fig. S1 ). Fig. 2 D-F are based on the latter threshold, and SI Appendix, Fig. S4 , shows the equivalent figures for the former. Third, we developed the Mismatching Isoform eXon Remover (MIXR) software package to detect and remove exons with alternate consensus runs directly (available at http://github.com/ hawkjo/mixr). By alternate consensus run, we mean the situation as shown in Fig. 2A , where some subset of species has a long run of amino acids which are internally consistent but which disagree from the majority of the sequences. While no substitution pattern in a single column of an alignment can distinguish real biological mutations from artifactual mismatching of isoforms, runs of an alternate consensus sequence are exponentially unlikely as a function of run length according to all site substitution models, so we want to remove them before analysis. Briefly, the MIXR algorithm works as follows. First, we define the alternateconsensus-run score, designed to give high scores to runs where some subset of species is internally consistent but differs from the majority of species. We then find the maximum alternateconsensus-run score for all species bipartitions (divisions of the species into two subsets) in a given alignment, such as the bipartition into transcriptomic and genomic species in Fig. 2A . Finally, exons with significant scores are removed. See Methods for additional details. Note that in all three of our cleaning steps, we have tried to avoid filtering on sequence divergence as much as possible. This is because our intention is to perform positive selection analysis on the cleaned alignments, an analysis which measures the ratio between nonsynonymous and synonymous mutations. Filtering strategies based on whether the protein sequences agree will directly bias the data in favor of synonymous mutations, and the exon-length-matching and MIXR steps are expected to have this effect to some degree. However, to whatever degree this is true in our data, it will have a conservative effect, biasing the data to fewer rather than more significant hits in a positive selection analysis. To measure the efficacy of each of our filtering steps, we looked at two different measures of the filtering process. First, we looked at unanimous second-consensus runs. We define unanimous second-consensus runs to be runs in an alignment For each species where transcriptome data are being used, the number of genes placed in an orthologous gene family based on all assemblies is reported (blue), as well as the number of genes which could have been found from the best single assembly alone, had it been known a priori (gold). Which assembly was best for each species is shown as the labels for gold bars, where TrinAll indicates the Trinity assembly using all reads, and TranskXX indicates the Trans-ABySS assembly using the De Bruijn graph of kmers of length XX. Number of genes added through use of multiple assemblies over the best assembly, and percentage increase, are shown to the right of the bars. Use of multiple assemblies added 9-22% more annotated orthologs per species relative to the best single assembly. Species with raw data generated for this paper are shown in blue type. where some subset of species has unanimous agreement of the amino acid sequence but disagrees with the majority of species. This is correlated with but distinct from the alternate-consensus runs defined for the MIXR algorithm as it is independent of the substitution model used for the MIXR scoring function. The results after each step of the cleaning process are shown in Fig.  2D . We see that the most significant reduction in secondconsensus runs is due to the exon structure filtering step, and MIXR cleaned up essentially all of the runs which passed the previous two steps. After cleaning, only seven runs of more than three columns were detected, and those were up to only five columns in length. Furthermore, all but one of these alignments contained only species with genome data available, removing the concern of separation by data type. As a second measure of alignment improvement, we checked that the filtered sequences had increased overall sequence conservation. Our strategy, as expected, preferentially discriminates against more weakly conserved sites [as defined by CLUSTAL (47) ], filtering >80% of nonconserved sites vs. 44% for unanimous sites, and almost all gapped sites (Fig. 2E) . Furthermore, V T V P S S SA A GT L F R G L C GA P DA P H P L SK I P GGR GGGR DP S V T V P S S SA A GT L FQ G L C GA P DA P H P L SK I P GGR GGGR DP S V T V P S S SA A GT L F R G L C GA P DA P H P L SK I P GGR GGGR DP S V T V P S S SA A GT L F R G L C GA P DA P H P L SK I P GGR GGGR DP S V T V P S S SA A GT L FQ G L C GA P DA P H P L SK I P GGR GG SR DP S V T V P S S SA A GT L FQ G L C GA P DA P H P L SK I P GGR GGGR DP S V T V P S S SA A GT L FQ G L C GA P DA P H P L SK I P GGR GG SR DP S V T V P S S SA A GT L FQ G L C GA P DA P H P L SK I P GGR GG SR DP S V T V P S S SA A GT L F R G L C GA P DA P H P L SK I P GGR GGGR DP S V T V P S S SA A GT L FQ G L C GA P DA P H P L SK I P GGR GGGR DP S V T V P S S SA A GT L FQ G L C GA P DA P H P L SK I P GGR GG SR DP S V T V P S S SA A GT L FQ G L C GA P DA P H P L SK I P GGR GGGR DP S -N C P Q L Q C C R H I V P GP L WC SDA P H P L SK I P GGR GGGR DP S -N C P Q L Q C C R H I V P GP L WC SDA P H P L SK I P GGR GGGR DP S -SC P Q L Q C C R H L V P GP L WC SDA P H P L SK I P GGR GGGR DP S -N C P Q L Q C C R H I V P GP L WC SDA P H P L SK I P GGR GGGR DP S -N C P Q L Q C C R H I V P GP L WC SDA P H P L SK I P GGR GGGR DP S -N C P Q L Q C C R H I V P GP L WC SDA P H P L SK I P GGR GGGR DP S -N C P Q L Q C C R H I V P GP L WC SDA P H P L SK I P GGR GGGR DP S Multiple sequence alignment cleaning. (A) Some multiple sequence alignments were observed to demonstrate isoform selection biased toward separation of genomic and transcriptomic data, causing nonrandom, nongapped errors segregated by the artifact of data type. (B) The alignment cleaning pipeline. First, each gene derived from genomic data was revisited to choose the isoform which best matches the consensus alignment sequence. Second, exons were filtered by structure, where exons with disagreement about boundary positions in the alignment and exons with >1% length difference between species were filtered out. Last, exons were filtered using the MIXR algorithm described in the text. (C) A total of 3,444 improved genomic isoform selections were performed, shown as a function of the improvement in percent matching the consensus sequence, i.e., (percent matching after) -(percent matching before). (D) Counts of unanimous second-consensus runs after each step of the alignment cleaning pipeline (with steps progressing from top to bottom in the graph). Unanimous second-consensus runs are defined as runs of more than three columns in a row where some minority of bat sequences agree with each other but disagree with those of all other bats. The final output contains only seven such runs with two or more species, and these are only up to three species and five amino acids long. (E) In each step of the alignment cleaning pipeline, weakly conserved sites are filtered at higher rates, enriching the final alignments for conserved sequences. "Strong," "Weak," and "None" conservation categories are as defined by Clustal (47) . Percent reduction in multiple sequence alignment column counts shown to the right. (F) Column conservation of the first 2,000 columns of the longest 2,000 alignments before and after exon filtering. both the exon-structure filtering step and the MIXR algorithm improve sequence conservation. Fig. 2F shows the positions and distribution of conserved sites in the first 2,000 multiple sequence alignments. Many of the poor quality exons are at the ends of the alignments, which is to be expected. The ortholog finding process scores sequences based on length of agreement, which naturally tends to include matching sections in the center. The ends are then more free to vary, with variability expected due to differences in isoform selection, as well as due to incomplete or incorrect transcript assembly. Transcripts tend to have less coverage near the ends and correspondingly poorer assembly. This also helps explain why so many unanimous sites end up being filtered: correctly matched exons will still be filtered if partial assembly results in exons of different lengths. From these results, as well as manual inspection, the alignments have significantly fewer erroneous columns after exon filtering. Phylogenetic Analysis. Phylogenetic trees were constructed from these multiple sequence alignments, using multiple strategies and software packages. First, using the 1,107 genes found in all species, we constructed the species tree with a partitioned nucleotide analysis in Mr. Bayes (48) , which fits for one species tree while allowing the model parameters to vary for each gene. Next, using the same genes, we constructed the species tree with concatenated data using RAxML (49) . This we did for the full coding sequence (CDS), the amino acid sequence, and each codon position separately. We additionally fit the phylogenetic tree using RAxML with the CDS sequence of the longest 100 alignments after subjecting the corresponding amino acid alignments to manual inspection. The full length of all 100 alignments looked highly credible to manual inspection. Finally, we constructed the 1,107 gene trees with all species using Mr. Bayes and determined the species tree via coalescent analysis as implemented in AS-TRAL (50) . This was done for the full CDS sequence and each codon position separately. The final tree is shown in Fig. 3A , with reported posterior probabilities given from the Mr. Bayes partitioned analysis. We refer to the final tree instead of a specific version of the final tree due to the strong consensus between methods. A summary of how the methods agreed or disagreed is shown in Fig. 3B . All methods converged on nearly the same species tree. In fact, due to the large amount of data, all nodes resolved with 100% reported posterior probability in both Mr. Bayes analyses. The only species not consistently placed in every analysis were Cynopterus sphinx and Murina leucogaster. Their alternative placements are shown in SI Appendix, Fig. S5 . Also included in Fig. 3B are comparisons with previously published trees, in particular, those that included most of the species in our analysis. All species placements in our final tree agree with these trees, with the exception of two previously controversial species, Rhinolophus ferrumequinum and Miniopterus schreibersii; one particularly close node involving C. sphinx; and one surprising placement, M. leucogaster. Other order-wide phylogenetic analyses were omitted from Fig. 3B due to minimal overlap with the species considered here. The placement of R. ferrumequinum addresses the first branching of the order Chiroptera. The traditional division of order Chiroptera into Megachiroptera and Microchiroptera, the large and small bats, respectively, has been challenged in recent years as molecular phylogenetic analyses have gained prominence. An alternative history has been proposed, dividing bats into two suborders named Yinpterochiroptera and Yangochiroptera (51) . In the proposal, the microbat families Rhinopomatidae, Rhinolophidae, Hipposideridae, and Megadermatidae are joined with the megabats to form the new clade Yinpterochiroptera, while the rest of the microbats form Yangochiroptera. Our phylogeny agrees with this model, with R. ferrumequinum falling into Yinpterochiroptera (Fig. 3A) . This restructuring has gained ad-ditional recent support (9, 11, 13, 15, 52) , although it must be noted that the accurate rooting of ancient species groups is a notoriously difficult aspect of phylogenetics (44) . The placement of M. schreibersii has also been unclear. Agnarsson's cytochrome B-based phylogeny places M. schreibersii just outside node H on our phylogeny. On the other hand, our placement of M. schreibersii agrees with Hoofer et al. (53) , who argued that due to this placement and the large divergence, Miniopteridae deserves to be its own family, and this agrees with the other phylogenies shown in Fig. 3B as well. The most surprising placement in our tree is that of M. leucogaster. In all of our calculated trees shown in Fig. 3B , with 100% reported posterior probability where calculated, M. leucogaster disrupts the monophyly of the genus Myotis ( Fig. 3B and  SI Appendix, Fig. S5 ). One must keep in mind, however, that the quantity of data here considered is so large it will tend to produce results with 100% reported posterior probability at each For each tree method, the rectangle at each node indicates agreement or disagreement with the consensus tree on the implied split at the node. Comparison with previously published trees is shown below. For nodes B, E, L, and P, the previously published trees agree with either our consensus phylogeny or a single alternative hypothesis: R. ferrumequinum above node G, C. sphinx above node C, M. schreibersii above node H, or M. leucogaster above node N, respectively. AA, amino acid sequence; C1-C3, the coding sequence restricted to those bases in the first, second, or third codon position, respectively; 100 manually inspected, phylogeny constructed using the longest 100 alignments after manual inspection for artifacts (none observed). node, pushing the question of credibility further upstream to the quality of the data. No data assembly and cleaning strategy, including our own, is perfect, and it is possible that sufficient errors remain in our data as to result in an erroneous topology of such closely related species. It at first even seems suggestive, given our previous observations of bias by data type, that M. leucogaster has moved closer than expected to Myotis ricketti, the Myotis species represented by transcriptomic data. SI Appendix, Fig. S6 , takes a focused look at the data for these five bats in the 100 manually (54) (55) (56) (57) (58) . We recognize that this placement is surprising given previously published work, but our results suggest the placement of M. leucogaster may merit further consideration. One final species placement of note is Desmodus rotundus. The family Phyllostomidae (New World leaf-nosed bats) here consists of the bats within the clade defined by node H. Wetterer, et al. (59) proposed that the genus Desmodus be placed sister to the rest of the phyllostomids, which were to have formed the subfamily Phyllostominae. Our placement of Macrotus californicus, however, disrupts Phyllostominae, in agreement with the tree proposed by Rojas et al. (60) . Positive Selection Analysis. Finally, we looked within bat genomes for signatures of positive selection acting on protein-coding genes. We used the PAML software package (61) to identify dN/dS > 1 codons within each of the orthologous gene alignments that we created. We used codon models M8 and M8a, which estimate the evolutionary pressures that have acted at specific codon sites over the entire phylogeny of species included. These models do not consider unique evolutionary scenarios that have affected gene evolution along different branches over the phylogenetic tree like some other models. In M8, the data in each multiple sequence alignment is fit to a model where one group of codons from within the alignment is allowed to evolve with dN/dS > 1. M8a is the null version of this model, where that same category of codons is allowed but is constrained to dN/dS = 1. Because there is one additional degree of freedom in M8, the data will usually fit better to the M8 model (as estimated by a likelihood value). A gene was deemed to be evolving under positive selection when the data are a statistically better fit to M8 than to M8a (P < 0.05 after correction for multiple tests; Dataset S1). We performed this analysis on 10,650 genes that met criteria of having at least six species and 30 codons represented in the alignment. Out of these, 181 genes met the statistical criteria for being subject to positive natural selection, and these genes were hand-curated for function (Dataset S1). Table 2 shows a subset of the genes. Nineteen percent are known to be involved in immunity or the replication cycles of pathogens. Surprisingly, 8% are known to be involved in collagen formation, including 10 out of the 27 top scoring genes for positive selection (Dataset S1). We also looked at the gene ontology (GO) classifications which are overrepresented in the list of genes under positive selection and present this data in Dataset S2. The GO categories most enriched for positively selected genes are dominated by immune responses and collagen formation. *These genes are placed in two categories on this table. † Relatively little is known about these genes, but they are expressed solely in the testis. 