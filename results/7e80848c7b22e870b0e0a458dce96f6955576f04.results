The CRISPR system functions as an adaptive immune system by incorporating DNA segments called 'protospacers' of infecting viruses into host genomes as 'spacers' that constitute sequencespecific immunity and memory [29] . From this perspective, strain diversification of both hosts and pathogens emerges from their frequency-dependent co-evolutionary dynamics, and involves the large combinatorics of spacers and protospacers. Previous work has shown the possibility of diverse populations, containing many strains, with distributed immunity of the host, whose dynamics can exhibit two alternating major regimes, escape and diversification of the viruses and dominance of the microbial host, respectively [38] . We extended the model to allow for larger host and virus richness, and to track the coevolutionary history of both hosts and viruses through time (Methods) . The timing of the switching between the two regimes (which is an emergent property of the model) is defined and identified here based on the dynamics of virus abundance (Methods). In the 'virus-diversification regime' (VDR), virus strains proliferate and diversify while in the 'hostcontrolled regime' (HCR) host strains are able to constrain virus diversification and lead to their extinction ( Fig. 1) . During the former, viruses and hosts coexist with fluctuating abundances, whereas during the latter, hosts reach carrying capacity and viruses exhibit declining abundances and richness followed by either escape or extinction (Figs. S3, S4, S5). Due to the stochastic nature of our simulations, the number of alternations between regimes varies. Nonetheless, for our set of parameters, the long-term dynamics of the system consists of complete virus extinction during one of the HCRs (see below and in Discussion for faster mutation rates). In most simulations (â‰ˆ 70%), viruses do not go rapidly extinct and exhibit instead one or more transient periods of diversification ( Fig. 1) , whereas in the rest, they show rapid extinction as hosts exert immediate control. Our analyses concentrate on the alternating transient dynamics that precede extinction. Variation in viral or host abundance alone cannot drive the transitions between these two regimes, as these do not exist in the corresponding Lotka-Volterra dynamics under neutral conditions of hosts not acquiring specific immunity (SI D,E). An alternative explanation is that the structure of strain diversity, emerging from the eco-evolutionary dynamics via specific immunity, explains the transitions between these dynamical regimes. To investigate the structure of diversity in this complex system, we consider two complementary bipartite networks, the 'immunity' and 'infection' graphs, through time. In these networks a node represents a strain of a virus (unique combination of protospacers) or a host (unique combination of spacers), and edges represent a given 5 . CC-BY-NC-ND 4.0 International license is made available under a The copyright holder for this preprint (which was not peer-reviewed) is the author/funder. It . https://doi.org/10.1101/850800 doi: bioRxiv preprint Virus diversification implies a temporary escape from host control and their rise in abundance, which in turn increases encounters with hosts. The resulting rise in per-capita infection rates of hosts leads to their concomitant diversification because new host strains are generated by acquiring at least one new protospacer. Therefore, despite an initial decline in the abundance of hosts', their richness typically rebuilds (Fig. S3) . type of interaction, either infection or protection from infection ( Fig. S6 ). At the start of the simulations and during VDRs, the infection network is built over time (by addition of host and virus strains) developing a modular structure in which infections are concentrated within modules of viruses and hosts, with more edges within than between these groups ( Fig. 2A, Fig. S7 ).These modules reflect different niches (hosts as resources) for virus growth. As proposed by the strain theory for multilocus antigen pathogens [13, 39, 40] , this niche structure arises in part from frequency-dependent competition among viruses for hosts. Specifically, viruses with rare escape mutations in protospacers to which hosts have not yet gained immunity exhibit a competitive advantage over those with abundant protospacers. Viruses with common protospacers are in turn at a disadvantage. The resulting frequency-dependent selection drives viruses to have little overlap in the hosts they can infect, and in so doing creates a modular structure which enables their coexistence and therefore their increasing diversity. The creation of niches is linked to the structured genetic diversity of the hosts, which is apparent in the also modular host-spacer network in which modules delineate groups of hosts that share immunity via the same spacers (Fig. S8 ). The importance of immune selection in the formation of these niches can be demonstrated by asking whether clonal expansion alone could account for the modularity of the infection network. This is not the case, as shown by randomizations of structure that reorder strains according to phylogenetic relationships, in which the modules are lost (Fig. S9) . Moreover, in the absence of frequency-dependent selection and associated host memory, diversification of the viruses and coexistence of different strains is not observed. This is demonstrated by a neutral model in which all the processes of the full system are retained except for the specific memory of the host (SI E). In contrast to strain theory [12, 15] , here the persistence of the modular structure in the infection network and the coexistence of a diverse community of viral strains is only transitory. The number of susceptible hosts available to all viruses declines very rapidly, so that no virus is able to infect all hosts. Interactions become organized into the modular structure, with hosts within a module becoming rapidly unavailable for viruses by either lysis or acquisition of protection. This closing of niches coupled with the inability of the viruses to escape makes the VDR effectively transient. To understand why virus escape becomes highly unlikely, we turn next to the structure of the protection network. Diversification of viruses, enabled by the modular structure of the infection network, increasingly diversifies the host population (Fig. S5) . In other words, escape from host control via mutation of protospacers allows higher abundances of particular virus strains, which therefore also experience 7 . CC-BY-NC-ND 4.0 International license is made available under a The copyright holder for this preprint (which was not peer-reviewed) is the author/funder. It . https://doi.org/10.1101/850800 doi: bioRxiv preprint Fig. S6 . Each network is a snapshot of the population, with time steps depicted above the networks corresponding to those marked in Fig. 3 . Numbers in the x and y axes indicate the number of viruses and hosts participating in each of the networks. Because the size of the matrix is limited, the width and height of the networks are not necessarily proportional to the number of strains (e.g. a reduced number of strains results in panels with larger squares). The purple and green lines depict the initiation of a virus-dominated and host-controlled regimes (VDR and HCR), respectively. a, Modularity in the infection network. Colored interactions fall inside modules of virus strains that infect similar hosts (each module has a different color). Black interactions are those that fall outside all modules. The size of the network and the number of modules increase during the VDR (between purple and green vertical lines) and decline during the HCR (right of the green vertical line). b, Weighted nestedness in immunity networks. Colors of interactions depict the number of matches between viruses and hosts. The network has a weighted-nested structure, which enforces an orderly viral extinction. Nestedness builds up during the VDR and declines during the HCR, as viruses go extinct. The extinction is orderly, with viruses to which many hosts has immunity via many spacers (those at the left), going extinct first. higher encounter rates with hosts in general, leading to the acquisition of new spacers (through either the failure of their previous immunity or infection by an escape mutant) (see details on the model in Methods). Such red-queen co-evolutionary dynamics progressively adds spacers to hosts during the VDR, building the immunity network (Fig. 2B) . In this network, edges indicate at least one spacer-protospacer match, and the weight of the edge encodes the number of different matches, protecting a given host from a given virus (Fig. S6C) . By definition, a lack of an edge indicates infection, and an edge value larger than one indicates redundancy in immunity. We find that this redundancy has a characteristic quantitative nested structure. We can order the network such that hosts with immunity to most viruses also have more matches to those viruses, and subsequent hosts (from top to bottom) are immune to subsets of viruses, via fewer matches ( Fig. S6G, Fig. 2B ). Similarly, each virus strain (from left to right) can infect a progressively smaller subset than the virus following it, also via fewer matches. The weighted nested structure is assembled by a complex interplay of temporal changes in abundances, associated encounter rates and selection pressures, in which host and viral age play an important role. How the matrix structure is woven from bottom to top, and left to right, with the respective addition of new hosts and viruses, is reflected in the relationship between the order of the rows and columns and strain age (Fig. S10 ). It is also the result of CRISPR failure, which allows infection and the acquisition of additional spacers. The nested pattern in the redundancy of immunity, built during a VDR, enforces order and predictability in virus extinctions during the subsequent HCR. Viruses for which most hosts have acquired immunity via multiple matches will tend to go extinct earlier than those with fewer matches (Fig. 2B, Fig. S11 ). Somewhat paradoxically, this orderly extinction will facilitate in turn a new viral escape and the stochastic initiation of another virus expansion cycle, as it reduces nestedness by preferentially removing viruses with a high number of matches. Hence, resistance to phages declines at the population level, rather than at the individual host level. Specifically, the extinction process reduces the competition for hosts between viruses to which hosts have either no match (0-match) or a single match (1-match) (Fig. 3B ) and therefore also increases their relative abundance in the populations. An increase in the proportion of 1-matches raises the effective mutation rate of the remaining viral population (SI C). Because viral escapes are associated with a particular tripartite structure in which hosts are immune to viruses via a single match (Fig. S12 ), the increase in the frequency of viral strains with potential to escape is crucial for the ability to initiate a new VDR. Epidemiologically, these two processes, viral growth rate and potential escape, can be captured via two modified measures of the basic reproductive number [41] (see SI B,C). The first, R 0 j (t), is the number of offspring produced at time t by the virus strain j from infecting all hosts with no protection to it (0-matches). The second, R 1 j (t), is the number of offspring that a virus strain j would produce by escaping protection from hosts via a single mutation (1-match) at time t. These two components can be added to obtain the 'potential reproductive number' of a virus strain j, R pot j (t) = R 0 j (t) + R 1 j (t), which quantifies the contribution of a viral strain and its potential progeny to the population growth, conditional on escape. During HCRs, the contribution of the second component R 1 j can raise R pot j above the critical 9 . CC-BY-NC-ND 4.0 International license is made available under a The copyright holder for this preprint (which was not peer-reviewed) is the author/funder. It . https://doi.org/10.1101/850800 doi: bioRxiv preprint Time % matches . Although the mean R 1 j is always < 1 (pink), R pot can be > 1. During these times, depicted with red points, a mutation would allow the viral population to grow. d, Even when R pot > 1 in the HCR, an escape is likely only when the mutation hits an abundant virus. The plot shows the viral abundance corresponding to high values of R pot . Specifically, this abundance is obtained by thresholding the distribution of R pot values across the simulation (shown in the inset) at its 90% quantile (dashed vertical line), and summing the abundance of all viruses whose reproductive number exceeds this threshold. Approaching the end of the HCR, high values of R pot j (i.e., above the 90% quantile) are concentrated in virus strains that are highly abundant due to the extinction of most other viruses. Because mutations are more likely to occur in highly abundant virus strains, it becomes likely that a mutation hits a virus with a high potential for virus growth, and therefore, escape. Vertical dashed lines indicate the time points for the network snapshots in Fig. 2 . 10 value of R pot j = 1 (Fig. 3C) , indicating a viable escape. Importantly, as a higher proportion of the viral abundance becomes concentrated in strains with the highest R pot j , escape mutations must occur on those viruses that would eventually initiate a new VDR (Fig. 3D ). Towards the end of an HCR, small viral outbreaks are observed of increasing frequency anticipating this critical transition (Fig. 1B) . The small epidemics locally generate some virus diversification which counterbalances extinctions. These opposite effects mean that towards the end of the HCR, nestedness inverts its decline and starts growing again. Extinctions and births of virus strains change both the size of the immunity network and the distribution of protection weights among the links. These two effects are reflected in the nestedness index [42] [43] [44] . To ensure the generality of our results given the stochastic nature of the dynamics, we repeated our analysis for 100 simulations. Across these simulations, we find the same characteristic differences between the regimes in dynamics and network structure as in our main example. In particular, VDRs are shorter than HCRs, have higher values of weighted nestedness, have more modules in the infection networks, and have higher values of R 0 j (Fig. S13 ). Together, these results indicate a general pattern of viral diversification via creation of host niches, the corresponding buildup of immunity in VDRs, and the breakdown of weighted nestedness that eventually leads to escape or extinction during HCRs. We also examined the effect of a five-fold acceleration in the speed of overall diversification of viruses, still within the general order of magnitude of plausible mutation rates. These "accelerated" simulations, which match the parameters used in ref [38] are also characterized by alternating regimes. The general outcome for simulations with higher mutation rates is a final sustained VDR with no virus extinction, preceded by a few HCRs. As expected, they exhibit higher richness of hosts and viruses, and episodes of virus diversification can be longer than for lower mutation rates (Fig. S14 ). Their infection networks are modular and the immunity networks are nested ( Fig. S15) . Although viral richness still declines sharply at the beginning of each HCR, the earlier and faster generation of new strains via small outbreaks maintains a higher richness than before throughout this regime. Thus, nestedness appears more consistent through time. Higher mutation rates also make more apparent a general feature of the dynamics (already present at lower values) that requires further investigation in the future; namely, trends of diversification superimposed on the alternating regimes. Specifically, subsequent HCRs (VDRs) exhibit a higher number of host (viral) strains, culminating in long episodes of fluctuating richness for both players. This temporal but long trend appears to be transient, in the sense that the end of one of the high-richness episodes 11 . CC-BY-NC-ND 4.0 International license is made available under a The copyright holder for this preprint (which was not peer-reviewed) is the author/funder. It . https://doi.org/10.1101/850800 doi: bioRxiv preprint re-initiates the alternating regimes at a low diversity of both hosts and viruses (not shown). Finally, we analyzed three unique empirical data sets. Ideally, one would consider temporal data on host-phage CRISPR matches. Such data are currently unavailable because obtaining it requires hundreds of genotypes of virus and CRISPR alleles to be resolved. Metagenomic datasets [31] can obtain such diversity but do not link spacers to individual host strains. Hence, currently available temporal data are either resolved at the strain level but for very low diversity [25, 32] or contain many spacers and protospacers but without host-phage CRISPR matches between multiple strains [31] . In fact, even for non-temporal data, there are very few examples of virus and host populations sufficiently resolved at an individual strain level. We considered here three such static data sets, and asked whether they exhibit evidence for the immunity structure predicted by the theory. We had previously established such profiles of diversity in naturally occurring microbial populations [27, 34, 45] but had not tested their structure in relation to immunity and infection networks. We use empirical data from three data sets in which both CRISPR alleles and virus strains have been carefully and manually assembled [27, 34] . These represent lytic, chronic and temperate virus lifestyles and two different microorganisms from the two domains of life where CRISPR occurs (archaea and bacteria). The first two data sets compare genomes resolved to individual strains of the thermoacidophilic crenarchaeon Sulfolobus islandicus sampled at a single time point from two different locations. The third data set is from the gamma proteobacteria Pseudomonas aeruginosa [27] , isolated from the sputum of CF patients in a high resolution longitudinal dataset collected by Marvig et al. [46] , with virus genomes obtained from the mu-like viruses from the genomic database because these are the most highly targeted temperate phage genomes in P. aeruginosa. From each data set, the empirical immunity matrices were constructed by comparing CRISPR arrays from each individual host strain to virus genomes. Because we did not have a time series, we assessed the statistical significance of nestedness for each empirical network by comparing the observed value of its nestedness index (for two different indices, Methods) to a distribution obtained from 10,000 shuffled networks. We find that the probability that a shuffled network will be more nested than the observed one is effectively nil (i.e., p-value< 0.0001; one-tailed test) in all three empirical networks ( Fig. 4, Fig. S16 ). In light of our theoretical results, these findings suggest that in these three systems hosts control populations of viruses via distributed immunity that is redundant in the number of matches. Moreover, we find that, as in our theoretical results, the empirical hostspacer networks are also modular (Fig. S16) , suggesting that the mechanism by which immunity 12 . CC-BY-NC-ND 4.0 International license is made available under a The copyright holder for this preprint (which was not peer-reviewed) is the author/funder. It The matrices depict the number of shared spacers and protospacers between hosts (rows) and viruses (columns). Each network is ordered by column and row sums and is nested in the quantity of matrix cells. The networks come from 3 different systems: a, Sulfolobus islandicus hosts from a single location in Yellowstone National Park compared to contemporary lytic SIRV viruses isolated from Yellowstone National Park. b, S. islandicus hosts compared to contemporary chronic SSV viruses from the Mutnovsky Volcano in Russia, 2010. (c, Pseudomonas aeruginosa hosts from Copenhagen compared to temperate mu-like viruses. To test the hypothesis that for a given distribution of matches in the population of host strains, the observed network is organized in a non-random, weighted-nested pattern, we shuffled networks by randomly distributing the interactions. is obtained is similar to the one we describe here. 