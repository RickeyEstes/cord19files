Phylogeny of RNA-dependent RNA polymerases. Protein sequences belonging to RNA viruses (excluding retroviruses) and to unclassified viruses were downloaded from the NCBI GenBank database in April 2017 (122) . Initial screening for RdRp domains was performed using PSI-BLAST (123) (E value of 0.01, effective database size of 2 ϫ 10 8 sequences) with position-specific scoring matrices (PSSMs) produced from the available RdRp alignments. The sources included group-specific alignments for ϩRNA viruses and dsRNA viruses (12, 31) and the 4 PFAM alignments for the ϪRNA viruses (pfam00602, pfam00946, pfam04196, and pfam06317) from the NCBI conserved domain database (CDD) (124) . Additionally, a set of RTs from group II introns and non-long-terminal-repeat (non-LTR) retrotransposons was extracted from GenBank as an outgroup. Extracted RdRp footprints were filtered for the fraction of unresolved amino acids (at most 10%) and clustered using UCLUST (125) with a similarity threshold of 0.9. One representative from each cluster was selected for further analysis. The resulting set contained 4,640 virus RdRps. This set went through several rounds of semimanual curation whereby sequences were clustered using UCLUST, aligned using MUSCLE (126) , and cross-searched against each other and their parent sequences (often representing complete viral polyproteins) using PSI-BLAST and HHSEARCH (127) . Upon obtaining the results of these searches, the boundaries of the RdRp domain were expanded or trimmed to improve their compatibility with each other. The RdRp and RT sequences were subjected to an iterative clustering and aligning procedure, organized as follows. Initially, sequences were clustered using UCLUST with a similarity threshold of 0.5. The clustered sequences were aligned using MUSCLE, and singletons were converted to pseudoalignments consisting of just one sequence. Sites containing more than 67% gaps were temporarily removed from alignments, and pairwise similarity scores were obtained for clusters by the use of HHSEARCH. Scores for a pair of clusters were converted to distances as follows: the d A,B ϭ Ϫlog[s A,B /min(s A,A ,s B,B ) formula, in which d A,B is the distance between cluster A and cluster B and s A,B is the HHSEARCH score for the comparison of these clusters, was used to convert scores s to distances d. The matrix of pairwise distances was used to calculate the mean by the unweighted pair group method using average linkages (UPGMA) (128) . Shallow tips of the tree were used as the guide tree for a progressive pairwise alignment of the clusters at the tree leaves using HHALIGN (127) , resulting in larger clusters. This procedure was reiterative, ultimately resulting in the single alignment of the whole set of 4,640 virus RdRp sequences and 1,028 RT sequences. During the clustering procedure, 50 virus RdRp clusters, consisting of 1 to 545 sequences, were defined. These clusters represented either well-established groups of related viruses (roughly comparable to the ICTV family rank) or, in case of poorly characterized and unclassified viruses, groups of well-aligned RdRps that were clearly distinct from others. In all cases, uncertainties were treated conservatively, i.e., favoring placing sequences with questionable relatedness into separate clusters. Additionally, RT sequences were placed into two clusters consisting of group II intron RTs and non-LTR retrotransposon RTs. For each cluster consisting of three or more sequences, an approximate maximum likelihood (ML) phylogenetic tree was constructed from the cluster-specific alignment using the FastTree program (129) (Whelan and Goldman [WAG] evolutionary model with gamma-distributed site rates) with sites that contained more than 50% gaps removed from the alignment. Trees were rooted using a variant of the midpoint rooting procedure such that the differences between the (weighted) average root-to-tip distances in the subtrees on the opposite sides of the root were minimized. To resolve the structure of the global relationships, up to five representatives from each cluster were selected using the within-cluster trees to ensure the diversity of the selected sequences. This procedure resulted in a set of 228 virus RdRps and 10 RTs. The alignments of the selected sequences were extracted from the master alignment and filtered for sites containing more than 50% gaps. A ML phylogenetic tree was reconstructed for the resulting alignment using PhyML (48) (Le Gascuel [LG] evolutionary model with gamma-distributed site rates and empirical amino acid frequencies; support values were calculated using aBayes method implemented in PhyML). Another form of branch support, i.e., bootstrap support provided by the transfer (BOOSTER) phylogenetic bootstrap method (130) , was also used to assess the reliability of the major tree divisions. Alternatively, the same RdRp alignment was used as the input for ML phylogenetic analysis using RAxML (LG evolutionary model with gamma-distributed site rates and empirical amino acid frequencies). RdRps in the global tree were divided into 5 major branches (supergroups). Up to 15 representatives from each cluster were selected to form supergroup-level alignments. The respective trees were reconstructed from these alignments using the same procedure (PhyML tree with LG evolutionary model with gamma-distributed site rates and empirical amino acid frequencies). The overall tree was assembled manually by first replacing the supergroup representatives in the global tree with the supergroup trees and then replacing the cluster representatives with the cluster trees. The lower-level trees were rooted according to the arrangement of the representatives in the upper-level tree. Identification of protein domains. Protein domains were identified using a representative set of RNA virus genomes, including representative members of ICTV-approved virus families and unclassified virus groups. This set was annotated manually using sensitive profile-profile comparisons with the HHsuite package (127) , and hmm profiles for annotated proteins or their domains were generated by running one iteration of HHblits against the latest (October 2017) uniclust30 database (131) . Each annotated profile was assigned to a functional category (e.g., Љcapsid protein_jelly-roll,Љ Љchymotrypsinlike proteaseЉ). These profiles were used to annotate the genomes of all of the viruses that were included in the RdRp phylogenetic analysis and for which complete (or near-complete) genome sequences were available. Profiles for the latter proteins were generated by running one iteration of Jackhmmer (132) against the UniRef50 database. Protein regions that did not have significant hits were extracted and clustered with cluster analysis of sequences (CLANS) (133) , and groups containing at least three members were identified, annotated (if possible), and added to the manually annotated profile database. The last step of the domain identification procedure was then repeated using the updated RNA virus profile database. Highly similar viruses (with identical domain organizations and Ͼ94% identical RdRps) were removed from the data set. In addition, only one representative genome was retained for some members of overrepresented species (e.g., Hepacivirus C). Many genomes (e.g., alphaviruses, tombusviruses, and nidoviruses) encoded readthrough proteins, resulting in domains from the shorter protein contained within the longer readthrough protein. Such redundancies were removed by filtering out the shorter of the two proteins sharing Ͼ80% identity. The final set of annotated genomes included 2,839 viruses. Reconstruction of the history of gene gain and loss. The protein domains identified in the 2,839 virus genomes were mapped onto the composite tree of virus RdRps. A set of 500 representatives was chosen among the (mostly complete) genomes. The domain complement data and the respective tree were analyzed using the GLOOME program (51) . Domain gains and losses were inferred at each tree branch using the difference of posterior probabilities for the domain occurrence in the nodes at the proximal and the distal ends of the branch (differences with values above 0.5 imply gain; differences with values below Ϫ0.5 imply loss). Clustering analysis. The SJR CP network was generated by performing all-against-all comparisons of the SJR CP profiles. To generate hmm profiles, SJR CP sequences were extracted from the total proteome of RNA viruses and two iterations of HHblits were performed against the uniprot20_2016_02 database. The resulting profiles were compared to each other with HHsearch (127) . Their similarity P values were extracted from the result files and used as an input for CLANS program (133) . Clusters were identified using a network-based algorithm implemented in CLANS. Resulting clusters were manually inspected and refined. Analysis of bipartite gene-genome networks. A bipartite network was built to study the patterns of gene sharing among viral genomes (44, 106) . After removal of genomes with fewer than 2 domains and of domains that appeared in less than 3 genomes, the network consisted of 2,829 nodes, of which 2,515 corresponded to genomes and 314 to domains. Genome and domain nodes were connected by links wherever a domain was present in a genome. A consensus community detection approach was used to identify the modules of the network (134, 135) . First, we ran 500 replicas with Infomap (136) (bipartite setting, using domains as factors) and built a similarity matrix by assigning to each pair of nodes a similarity value equal to the fraction of replicas in which both nodes were placed in the same module. Then, hierarchical clustering was performed on the similarity matrix, setting the number of clusters equal to the median number of modules obtained in the 500 replicas. Order statistics local optimization method (Oslom) software (137) was subsequently used to filter significant modules with a P value threshold equal to 0.05. To detect higher-order (super)modules, we first identified connector domains as those present in at least 2 modules with prevalence greater than 0.65. The second-order network, composed of 54 modules and 34 connector domains, was searched for second-order modules with Infomap (500 replicas, bipartite setting with connector domains as factors). Due to the small size of the second-order network, consensus community detection did not qualitatively improve the results of the search, and therefore we took the replica with the best Infomap score and skipped hierarchical clustering for this and subsequent steps of the higher-order module search. After assessing statistical significance with Oslom, 4 second-order modules were recovered, encompassing 12 of the original modules associated with closely related virus families. A third-order network was built by pooling the 4 second-order modules with the 46 modules that remained unmerged. The third-order network was analyzed in the same manner to obtain the 9 supermodules. None of these supermodules was assessed by Oslom as significant. Quantification of virus host range diversity. Known hosts or, in case of viruses isolated from holobionts, virus sources were identified for 3,456 viruses. The host taxonomy (analyzed to the phylum level) was mapped to the leaves of the combined tree. The tree was ultrametrized, and the weights were computed for all leaves as described in reference 138. Each internal node of the tree therefore defines a set of leaves with assigned hosts; the distribution of (weighted) relative frequencies of hosts can be characterized by its Shannon entropy. Each leaf has one host defined such that the entropy of the host range distribution is 0 whereas the host diversity is maximal at the root. The entropy generally declines along the tree because viruses that belong to relatively shallow branches tend to share their host ranges. The node depth versus node host range entropy data were averaged for each major branch separately using a Gaussian kernel with a bandwidth equal to 10% of the total tree depth. 


Section:materials and methods