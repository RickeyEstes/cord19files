Six methods are applied to the sequence and HLA information simulated under 100 independent birth-death processes (described in the Methods subsection Simulation study 2: A sampled birth death process): 6. Our methodology as described in the Methods section of the main text. In each case, we assume that the consensus 'wild type' strain is correctly defined and set any nonsynonymous difference from consensus as escape. For methods 2, 4 and 5, we determine a maximum likelihood estimate of the underlying genealogy using RAxML version 8.2.11 [11] . Methods 1, 3 and 6 do not require an estimate of the genealogy. We now briefly summarise each of the compared methods. Fisher's exact test A simple Fisher's exact test is applied by splitting the query sequences according to the following 2 × 2 contingency  where λ esc and λ esc , β, c and f HLA are estimates of the population escape and reversion rates, transmission probability, contact rate, and proportion of individuals in the population with the HLA type under investigation. Λ 0 and Λ 1 are the proportion of HLA mismatched hosts with an escape mutant at the investigated site, and proportion of HLA matched hosts with an escape mutant at the investigated site. We note that neither β nor c are required to preserve the ordering of escape and reversion rates, and as such do not affect the associated ROC curves. The ordering is also preserved at the stationary phase [8] . In cases where the resultant escape or reversion rate estimate is negative, we set the escape rate estimate at zero under the assumption that the model does not fit the simulated data. PhyloD We implement the methods of Carlson et al. as described in [9] . As described above, we determine an estimate of the maximum likelihood tree, G max using RAxML [11] before using likelihood ratio tests to compare models conditional on the maximum likelihood tree. The initial null model at each site is a simple two state model described by two parameters -the mutation rate; λ, and the stationary probability of observing the wild-type amino acid; π. The associated instantaneous rate matrix is Felsenstein's peeling algorithm [13] is then used to evaluate the likelihood L(λ, π|D, G max ) and maximised, where D is the combination of simulated query sequences and associated host HLA data. So called 'leaf-distributions' are then potentially added using forward selection. This involves the inclusion of further hidden states -estimates of the transmitted sequence for each subsequently sampled member of the query sequences set. This transmitted sequence is then potentially modified conditional on the hosts' HLA. In the case of escape, the probability of an instantaneous switch from wild-type to escape is parameterised by a probability; p. Thus, given Q above for the remainder of the tree, and probabilities of switching between states between the hidden 'transmitted sequence' and the query sequences at the leaves, we can evaluate L(λ, π, p|D, G max ) using tree peeling. Maximising this likelihood and comparing to the current null model, parameters are added if the p-value for the associated likelihood ratio test is lower than 0.05. Whereas in Carlson et al. maximum likelihood parameterisations are obtained by either coordinate descent [14] or expectation-maximisation [9] , we take a pragmatic approach, as often certain optimisation schemes fail under different scenarios. To this end, we simultaneously run six different optimisation schemes built into the optimx R package [15] : Nelder-Mead [16] , L-BFGS-B [17] , ucminf [18] , nmkb [19] , newuoa [20] , bobyqa [21] . We stipulate that at least two schemes must converge, and choose the likelihood parameterisation of the scheme with the highest likelihood. If less than two schemes converge, new starting parameters are chosen at random and estimates are re-evaluated. PhyloD OR A slight modification of PhyloD, PhyloD OR also involves a simple alteration of the standard peeling algorithm, but instead of a 'leaf-distribution' being added at the leaves, a logistic regression is applied between the hidden transmitted states and the observed sequence data at the leaves -see Carlson et al. for some details [10] . Likelihoods can then be evaluated based on the probabilities associated to this logistic regression fit using a peeling algorithm [13] . E.g. Rearranging where P is the probability of observing an escape mutation, X i are binary variables taking the value 0 or 1 (for presence/absence of HLA i) depending on the HLA status of the host associated to a given leaf sequence. T is a further binary variable, which takes the value -1 if the state at the hidden transmitted state is wild-type, and 1 if it is escape. Given that these transmitted states are unknown, they are summed over using tree peeling. a i s and c are fitted using maximum likelihood optimisation schemes as for PhyloD. Following Carlson et al. we again use forward selection and likelihood ratio tests and add parameters to the model if p < 0.05. Using each of the five methods described above, plus our new approach as described in detail in the methods section of the main text, we obtain p-values or parameter estimates which provide a metric for the strength of selection for escape at each site, conditional on each of the HLA types. We use the p-value, p-value, escape rate estimate, probability estimate, strength of selection; a i , and median HLA associated selection parameters; γ h for each of the six methods respectively to determine ROC curves for each of the 100 simulated sequence and host HLA data sets, displayed in Figure 2 of the main text. We also examined the effect of increasing the query sequence set with associated host HLA information to 3000. The resultant ROC curves for each of the five methods are shown in Supplementary Figure  7 . To examine the impact of a reduced reference data set D B upon parameter estimates, we subset to 100%, 10% and 1% of the reference sets in Simulation Study 2. We then performed inference and determined the impact of a smaller D B on the accuracy of our results. ROC curves for our method with different reference data sets sizes are shown in Supplementary Figure 8 . 


Section:simulation study 2: methods comparison