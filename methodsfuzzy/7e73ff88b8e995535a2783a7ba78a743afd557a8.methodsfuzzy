Sequences and alignments. Virus sequences were retrieved from the NCBI database and a list of accession numbers is provided as Supplementary Table S1 . Sequences of Ty-BatCoV HKU4 and Pi-BatCoV HKU5 isolated in Hong Kong were derived from a previous work 28 . Errors in the inferred multiple sequence alignment (MSA), which may be common when highly divergent sequences are analyzed, can inflate estimates of positive selection. We therefore used PRANK 45 for building the MSA and GUIDANCE 46 for filtering unreliably aligned codons (i.e. we masked codons with a score < 0.90), as suggested 35 . Detection of recombination and positive selection. To detect positive selection at the S gene of clade c betaCoVs we applied the branch-site test from the PAML suite 22 . The test compares a model (MA) that allows positive selection on one or more lineages (foreground lineages) with a model (MA1) that does not allow such positive selection. Twice the difference of likelihood for the two models (Δ lnL) is then compared to a χ 2 distribution with one degree of freedom 22 . Specifically, the internal branches of previously reconstructed 6 Bayesian phylogenies of the S1 and S2 regions were set as the foreground lineages in independent tests. A false discovery rate (FDR) correction was applied to account for multiple hypothesis testing (i.e. we corrected for the number of tested branches), as suggested 47 . Positively selected sites were identified through the BEB analysis (with a p value cutoff of 0.90), which calculates the posterior probability that each site belongs to the site class of positive selection on the foreground branch(es). Sites were validated using MEME (with the default cutoff of 0.1), which allows the distribution of dN/dS (also referred to as ω ) to vary from site to site and from branch to branch at a site, therefore allowing the detection of episodic positive selection 24 . The site models implemented in PAML were applied -independently-for the analysis of HKU4 and MERS-CoV sequences, which display very limited divergence and do not suffer from saturation problems. To detect selection, site models that allow (M2a, M8) or disallow (M1a, M7) a class of sites to evolve with ω > 1 were fitted to the data 48 . Trees were generated by maximum-likelihood using the PhyML program 49 with a GTR model of nucleotide substitution and γ distributed rates. Positively selected sites were identified using the BEB analysis (from model M8) 50 . Again, sites were validated using MEME. To assure consistency, all models were run using the F3 × 4 and the F61 codon frequency models. MSAs were screened for the presence of recombination using GARD. Recombination breakpoints were considered significant if the HK (Kishino-Hasegawa) p value was < 0.01. Simultaneous inference of selection and recombination for analysis of positive selection was performed using omegaMap 29 , a program for detecting natural selection and recombination based on a model of population genetics and molecular evolution. The model uses a population genetic approximation to the coalescent with recombination. This latter is estimated from patterns of linkage disequilibrium assuming that recombination events occur only between codons and not within them. OmegaMap applies reversible-jump Markov Chain Monte Carlo (MCMC) to perform Bayesian inferences of both ω and the recombination parameter ρ , allowing both parameters to vary along the sequence. An average block length of 10 and 30 codons was used to estimate ω and ρ , respectively. To determine the influence of the choice of the priors on the posteriors, analyses were repeated with alternative sets of priors (Supplementary Table S2 ). Three independent omegaMap runs, each with 500,000 iterations and a 50,000 burn-in iteration, were compared to assess convergence and merged to obtain the posterior probability estimate. The REL (random effects likelihood) analysis models variation in both dN and dS across sites according to a predefined distribution with different rate classes; positively selected sites are identified through an empirical Bayes method 51 . The default criterion of a Bayes Factor > 50 was used to identify positively selected sites. For GARD, MEME, and REL the nucleotide substitution models were chosen using a Genetic Algorithm implemented in the dataMonkey suite 52 . All analyses were performed through the DataMonkey server 53 (http://www.datamonkey.org). In silico analysis of HR1 variants. The crystal structure of MERS-CoV HR1 and HR2 region was obtained from PDB (PDB ID: 4MOD). Histidine or arginine residues were introduced at positions 1020 and suitable rotamers were sampled through the rapid torsion scan utility in Maestro (Maestro. 9.1; Schrodinger). Intraprotein interactions were calculated with PIC (protein interaction calculator) 54 . Because programs that calculate stability changes achieve only moderate accuracy 55 , we used three different methods to assure reliability. These approaches are based on different principles. Specifically, PoPMuSiC uses statistical potentials and takes into account amino acid volume variation upon mutation 33 ; FoldX uses an empirical force field and evaluates the energetic effect of point mutations and the interactions contributing to the stability of proteins 32 . Finally, I-Mutant 2.0 is based on a neural network approach to evaluate the free energy change after a single point mutation with incorporation of information on the three-dimensional structure of the protein 34 . In FoldX and I-Mutant the Δ Δ G values are calculated as follows: ΔΔG = ΔG mutant − ΔG wild-type . In FoldX and I-Mutant Δ Δ G values > 0 kcal/mol indicate mutations that decrease protein stability, whereas in PoPMuSiC Δ Δ G values > 0 kcal/mol are mark of mutations increasing protein stability. Therefore, PoPMuSiC Δ Δ G values were multiplied by − 1 to obtain homogeneous results. In the analysis carried out with FoldX 3D, the three-dimensional structure of the protein was repaired using the < RepairPDB> command. Mutations were introduced using the < BuildModel> command with < numberOfRuns> set to 5 and < VdWdesign> set to 0. Temperature (298K), ionic strength (0.05 M) and pH (7) were set to default values and the force-field was used to predict the water molecules on the protein surface. 


Section:materials and methods